#!/bin/sh

# disable recurring reboots,
# comment if you want to go to Alt-F on every reboot
ONCE=yes 

TMP_DIR=/tmp
BASE_DIR=/mnt/HD_a2
ALTF_DIR=alt-f
ALTF_PATH=$BASE_DIR/alt-f
ALTF_TARBALL=$BASE_DIR/Alt-F-*.tar

check() {
	if ! test -r $1; then
		echo "$1 not found, exiting"
		exit 1
	fi
}

cd $BASE_DIR

if test -r $ALTF_TARBALL; then
    # tar xzf $ALTF_TARBALL
	# what the heck?! -x doesn't work, but -v does, so extract to stdout!
	mkdir $ALTF_PATH
	for i in $(tar -tf $ALTF_TARBALL); do
		if ! test -d $i; then
			tar -xOf $ALTF_TARBALL $i > $i
		fi
	done
    rm $ALTF_TARBALL
	chown -R nobody:nobody alt-f
fi

cd $ALTF_PATH

KV=$(uname -r)
kernel=zImage
initrd=rootfs.arm.cpio-sq.lzma
machtype=1542
cmdline="console=ttyS0,115200"

check "$kernel"
check "$initrd"
check "reloaded-$KV.ko"

cat<<EOF > $TMP_DIR/reload.sh

# disable recurring reboots
if test "$ONCE" = yes; then
	chmod -x $BASE_DIR/fun_plug
fi

# stop processes
smb stop
proc="apkg atd crond wget smbclient pure-ftpd prescan upnp mt-daapd lpd inotify_itune inotify_upnp btdog bt inotifybt UpdateDB check_hotplug xmldb webs"

for i in $proc; do
	if test -n "$(pidof $i)"; then
		kill $(pidof $i)
		sleep 1
		if test -n "$(pidof $i)"; then
			kill -9 $(pidof $i)
		fi
	fi
done
sleep 3
ps

# umount filesystems
swapoff -a
sync
umount -a -r
sleep 3

# boot
insmod reloaded-$KV.ko machtype=$machtype kernel=$kernel initrd=$initrd cmdline=\"$cmdline\"
echo "Reload failed!"
EOF

chmod +x $TMP_DIR/reload.sh
exec $TMP_DIR/reload.sh >/dev/console 2>&1 </dev/null
